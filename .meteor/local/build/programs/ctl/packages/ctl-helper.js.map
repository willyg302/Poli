{"version":3,"file":"\\packages\\ctl-helper.js","sources":["ctl-helper/ctl-helper.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;AAAA,uC;AACA,0C;;AAEA,S;;AAEA,e;AACA,e;;AAEA,yB;AACA,4B;AACA,6B;AACA,2B;AACA,oB;;AAEA,oB;AACA,kC;AACA,uB;AACA,K;;AAEA,yB;AACA,sB;AACA,sC;;AAEA,wC;AACA,a;AACA,I;;AAEA,gC;AACA,uD;AACA,gB;AACA,4E;AACA,sB;AACA,K;;AAEA,e;AACA,I;;AAEA,kC;AACA,qC;AACA,kB;AACA,yE;AACA,sB;AACA,K;;AAEA,8C;AACA,K;;AAEA,sC;AACA,sE;AACA,K;;AAEA,4D;AACA,oD;AACA,+D;AACA,K;;AAEA,6B;AACA,oD;AACA,kC;AACA,oC;AACA,kC;AACA,uB;AACA,yC;AACA,+C;AACA,I;;AAEA,iC;AACA,yC;AACA,kE;AACA,sB;AACA,K;AACA,kC;AACA,K;;AAEA,+B;AACA,yC;AACA,kE;AACA,sB;AACA,K;AACA,kC;AACA,K;;AAEA,qB;AACA,yB;AACA,kD;AACA,c;AACA,qF;AACA,oF;AACA,sD;AACA,c;AACA,uB;AACA,yC;AACA,qC;AACA,yE;AACA,6D;AACA,O;AACA,O;AACA,+B;AACA,yB;AACA,8D;AACA,oB;AACA,I;;AAEA,gD;AACA,6C;AACA,8B;;AAEA,0C;AACA,iC;;AAEA,oC;AACA,Y;AACA,uC;AACA,2C;AACA,8D;;AAEA,oB;AACA,I;;AAEA,gD;AACA,uD;AACA,S;AACA,yC;AACA,iB;AACA,qC;AACA,K;AACA,e;AACA,I;;AAEA,uC;AACA,qD;AACA,oD;AACA,G;AACA,G","sourcesContent":["var optimist = Npm.require('optimist');\r\nvar Future = Npm.require('fibers/future');\r\n\r\nCtl = {};\r\n\r\n_.extend(Ctl, {\r\n  Commands: [],\r\n\r\n  main: function (argv) {\r\n    var opt = optimist(argv)\r\n          .alias('h', 'help')\r\n          .boolean('help');\r\n    argv = opt.argv;\r\n\r\n    if (argv.help) {\r\n      argv._.splice(0, 0, \"help\");\r\n      delete argv.help;\r\n    }\r\n\r\n    var cmdName = 'help';\r\n    if (argv._.length)\r\n      cmdName = argv._.splice(0,1)[0];\r\n\r\n    Ctl.findCommand(cmdName).func(argv);\r\n    return 0;\r\n  },\r\n\r\n  findCommand: function (name) {\r\n    var cmd = _.where(Ctl.Commands, { name: name })[0];\r\n    if (! cmd) {\r\n      console.log(\"'\" + name + \"' is not a ctl command. See 'ctl --help'.\");\r\n      process.exit(1);\r\n    }\r\n\r\n    return cmd;\r\n  },\r\n\r\n  findGalaxy: _.once(function () {\r\n    if (!('GALAXY' in process.env)) {\r\n      console.log(\r\n        \"GALAXY environment variable must be set. See 'galaxy --help'.\");\r\n      process.exit(1);\r\n    }\r\n\r\n    return DDP.connect(process.env['GALAXY']);\r\n  }),\r\n\r\n  jobsCollection: _.once(function () {\r\n    return new Meteor.Collection(\"jobs\", {manager: Ctl.findGalaxy()});\r\n  }),\r\n\r\n  // use _.memoize so that this is called only once per app.\r\n  subscribeToAppJobs: _.memoize(function (appName) {\r\n    Ctl.findGalaxy()._subscribeAndWait(\"jobsByApp\", [appName]);\r\n  }),\r\n\r\n  // XXX this never unsubs...\r\n  getJobsByApp: function (appName, restOfSelector) {\r\n    var galaxy = Ctl.findGalaxy();\r\n    Ctl.subscribeToAppJobs(appName);\r\n    var selector = {app: appName};\r\n    if (restOfSelector)\r\n      _.extend(selector, restOfSelector);\r\n    return Ctl.jobsCollection().find(selector);\r\n  },\r\n\r\n  myAppName: _.once(function () {\r\n    if (!('GALAXY_APP' in process.env)) {\r\n      console.log(\"GALAXY_APP environment variable must be set.\");\r\n      process.exit(1);\r\n    }\r\n    return process.env.GALAXY_APP;\r\n  }),\r\n\r\n  myJobId: _.once(function () {\r\n    if (!('GALAXY_JOB' in process.env)) {\r\n      console.log(\"GALAXY_JOB environment variable must be set.\");\r\n      process.exit(1);\r\n    }\r\n    return process.env.GALAXY_JOB;\r\n  }),\r\n\r\n  usage: function() {\r\n    process.stdout.write(\r\n      \"Usage: ctl [--help] <command> [<args>]\\n\" +\r\n        \"\\n\" +\r\n        \"For now, the GALAXY environment variable must be set to the location of\\n\" +\r\n        \"your Galaxy management server (Ultraworld.) This string is in the same\\n\" +\r\n        \"format as the argument to DDP.connect().\\n\" +\r\n        \"\\n\" +\r\n        \"Commands:\\n\");\r\n    _.each(Ctl.Commands, function (cmd) {\r\n      if (cmd.help && ! cmd.hidden) {\r\n        var name = cmd.name + \"                \".substr(cmd.name.length);\r\n        process.stdout.write(\"   \" + name + cmd.help + \"\\n\");\r\n      }\r\n    });\r\n    process.stdout.write(\"\\n\");\r\n    process.stdout.write(\r\n      \"See 'ctl help <command>' for details on a command.\\n\");\r\n    process.exit(1);\r\n  },\r\n\r\n  // XXX copied to meteor/tools/deploy-galaxy.js\r\n  exitWithError: function (error, messages) {\r\n    messages = messages || {};\r\n\r\n    if (! (error instanceof Meteor.Error))\r\n      throw error; // get a stack\r\n\r\n    var msg = messages[error.error];\r\n    if (msg)\r\n      process.stderr.write(msg + \"\\n\");\r\n    else if (error instanceof Meteor.Error)\r\n      process.stderr.write(\"Denied: \" + error.message + \"\\n\");\r\n\r\n    process.exit(1);\r\n  },\r\n\r\n  // XXX copied to meteor/tools/deploy-galaxy.js\r\n  prettyCall: function (galaxy, name, args, messages) {\r\n    try {\r\n      var ret = galaxy.apply(name, args);\r\n    } catch (e) {\r\n      Ctl.exitWithError(e, messages);\r\n    }\r\n    return ret;\r\n  },\r\n\r\n  kill: function (programName, jobId) {\r\n  console.log(\"Killing %s (%s)\", programName, jobId);\r\n  Ctl.prettyCall(Ctl.findGalaxy(), 'kill', [jobId]);\r\n  }\r\n});\r\n"]}